# -*- coding: utf-8 -*-
"""eval_clahe

Automatically generated by Colab.

Original file is located at
    https://colab.research.google.com/drive/1NLuOFDUQYyNejbR-O_uGTgTHq-RMP959
"""

# -*- coding: utf-8 -*-
"""
Evalúa CLAHE bajo una condición (p. ej., 'fog') usando métricas NIQE/PIQE
y registra resultados en MLflow.
Uso (Colab):
    !pip install -r requirements.txt
    from google.colab import drive; drive.mount('/content/drive')
    import os; os.environ["MLFLOW_TRACKING_URI"] = "file:///content/drive/MyDrive/mlruns"
    !python eval_clahe.py --data "/content/drive/MyDrive/datasets/fog" --condition fog --clip 2.0 --tiles 8
"""

import os
import argparse
import numpy as np
import mlflow

from utils.dataset_loader import load_images_bgr, bgr_to_rgb
from preprocessing.clahe_enhance import apply_clahe
from metrics.niqe_metric import calculate_niqe
from metrics.piqe_metric import calculate_piqe
from metrics.brisque_metric import calculate_brisque

def parse_args():
    ap = argparse.ArgumentParser()
    ap.add_argument("--data", required=True, help="Carpeta con imágenes de la condición adversa (ej. fog)")
    ap.add_argument("--condition", default="fog", help="Etiqueta de la condición (fog/rain/snow/lowlight)")
    ap.add_argument("--clip", type=float, default=2.0, help="clipLimit de CLAHE")
    ap.add_argument("--tiles", type=int, default=8, help="tileGridSize (entero, se usa NxN)")
    ap.add_argument("--experiment", default="preprocessing-eval", help="Nombre del experimento en MLflow")
    return ap.parse_args()

def main():
    args = parse_args()

    # Asegurar experimento
    mlflow.set_experiment(args.experiment)

    with mlflow.start_run(run_name=f"CLAHE_{args.condition}"):
        mlflow.log_param("technique", "CLAHE")
        mlflow.log_param("condition", args.condition)
        mlflow.log_param("clip_limit", args.clip)
        mlflow.log_param("tile_grid", f"{args.tiles}x{args.tiles}")

        imgs_bgr = load_images_bgr(args.data)
        niqe_vals, piqe_vals, brisque_vals = [], [], []
        
        for img_bgr in imgs_bgr:
            # Preprocesamiento
            proc_bgr = apply_clahe(
                img_bgr,
                clip_limit=args.clip,
                tile_grid_size=(args.tiles, args.tiles),
            )
            proc_rgb = bgr_to_rgb(proc_bgr)
        
            # Métricas no-referenciales
            niqe_vals.append(calculate_niqe(proc_rgb))
            piqe_vals.append(calculate_piqe(proc_rgb))
            brisque_vals.append(calculate_brisque(proc_rgb))
        
        # Promedios
        niqe_avg = float(np.mean(niqe_vals))
        piqe_avg = float(np.mean(piqe_vals))
        brisque_avg = float(np.mean(brisque_vals))
        
        mlflow.log_metric("NIQE_avg", niqe_avg)
        mlflow.log_metric("PIQE_avg", piqe_avg)
        mlflow.log_metric("BRISQUE_avg", brisque_avg)



        # Promedios
        niqe_avg = float(np.mean(niqe_vals))
        piqe_avg = float(np.mean(piqe_vals))

        mlflow.log_metric("NIQE_avg", niqe_avg)
        mlflow.log_metric("PIQE_avg", piqe_avg)

        # Artefacto simple: guardamos un .txt con resumen
        summary = (
            f"Technique: CLAHE\n"
            f"Condition: {args.condition}\n"
            f"clip_limit: {args.clip}\n"
            f"tile_grid: {args.tiles}x{args.tiles}\n"
            f"NIQE_avg: {niqe_avg:.4f}\n"
            f"PIQE_avg: {piqe_avg:.4f}\n"
            f"BRISQUE_avg: {brisque_avg:.4f}\n"
        )

        os.makedirs("artifacts", exist_ok=True)
        with open("artifacts/summary.txt", "w", encoding="utf-8") as f:
            f.write(summary)
        mlflow.log_artifact("artifacts/summary.txt")

        print("✅ Evaluación completada.")
        print(summary)

if __name__ == "__main__":
    main()
