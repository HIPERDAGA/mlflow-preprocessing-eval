# -*- coding: utf-8 -*-
"""niqe_metric

Automatically generated by Colab.

Original file is located at
    https://colab.research.google.com/drive/1NLuOFDUQYyNejbR-O_uGTgTHq-RMP959
"""

# -*- coding: utf-8 -*-
import numpy as np

# Preferimos pyiqa por estabilidad (incluye NIQE y PIQE)
# pip install pyiqa
try:
    import pyiqa
    _NIQE = pyiqa.create_metric('niqe', device='cpu')
except Exception as e:
    _NIQE = None
    _IMPORT_ERR = e

def calculate_niqe(img_rgb: np.ndarray) -> float:
    """
    Calcula NIQE (No-Reference) usando pyiqa.
    - img_rgb: imagen en RGB (0-255, uint8) o (0-1, float)
    Retorna: float (menor es mejor)
    """
    if _NIQE is None:
        raise RuntimeError(
            f"No se pudo inicializar NIQE (pyiqa). Instala con `pip install pyiqa`. Error: {_IMPORT_ERR}"
        )
    # pyiqa espera tensores CHW en [0,1], convertimos internamente
    import torch
    img = img_rgb.astype(np.float32)
    if img.max() > 1.0:
        img = img / 255.0
    chw = torch.from_numpy(img).permute(2, 0, 1).unsqueeze(0)  # 1xCxHxW
    score = _NIQE(chw).item()
    return float(score)